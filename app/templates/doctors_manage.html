{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4"><h2>üè• –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ü–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2><button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDoctorModal" onclick="loadDepartments()">‚ûï –î–æ–¥–∞—Ç–∏ –õ—ñ–∫–∞—Ä—è</button></div>
<div class="card shadow"><div class="card-body"><table class="table table-hover align-middle"><thead class="table-dark"><tr><th>ID</th><th>–ü–Ü–ë</th><th>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è</th><th>–¶—ñ–Ω–∞ –≤—ñ–∑–∏—Ç—É</th><th>–°—Ç–∞—Ç—É—Å (–†–æ–±–æ—Ç–∞)</th><th>–î—ñ—ó</th></tr></thead><tbody id="doctorsTableBody"></tbody></table></div></div>

<div class="modal fade" id="addDoctorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">–ù–æ–≤–∏–π –õ—ñ–∫–∞—Ä</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addDoctorForm"><div class="row mb-2"><div class="col"><input type="text" class="form-control" id="newFirst" placeholder="–Ü–º'—è" required></div><div class="col"><input type="text" class="form-control" id="newLast" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" required></div></div><input type="text" class="form-control mb-2" id="newSpec" placeholder="–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è" required><input type="number" class="form-control mb-2" id="newPrice" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)" required><div class="mb-3"><label class="form-label fw-bold">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label><select class="form-select" id="newDept" required><option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option></select></div><div class="border p-2 rounded bg-light mb-3"><label class="form-label fw-bold mb-1">–ì—Ä–∞—Ñ—ñ–∫ (–ü–Ω-–ü—Ç):</label><div class="input-group"><span class="input-group-text">–ó</span><input type="time" class="form-control" id="schedStart" value="09:00"><span class="input-group-text">–î–æ</span><input type="time" class="form-control" id="schedEnd" value="17:00"></div></div><button type="submit" class="btn btn-success w-100">–°—Ç–≤–æ—Ä–∏—Ç–∏</button></form></div></div></div></div>
<div class="modal fade" id="editDoctorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="editDoctorForm"><input type="hidden" id="editDocId"><div class="mb-2"><label>–Ü–º'—è:</label><input type="text" class="form-control" id="editFirst"></div><div class="mb-2"><label>–ü—Ä—ñ–∑–≤–∏—â–µ:</label><input type="text" class="form-control" id="editLast"></div><div class="mb-2"><label>–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è:</label><input type="text" class="form-control" id="editSpec"></div><div class="mb-2"><label>–¶—ñ–Ω–∞ –≤—ñ–∑–∏—Ç—É:</label><input type="number" class="form-control" id="editPrice"></div><button type="submit" class="btn btn-warning w-100 mt-3">–ó–±–µ—Ä–µ–≥—Ç–∏</button></form></div></div></div></div>
<div class="modal fade" id="scheduleModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">–ì—Ä–∞—Ñ—ñ–∫ –†–æ–±–æ—Ç–∏</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="scheduleForm"><input type="hidden" id="schedDocId"><table class="table table-sm"><thead><tr><th>–î–µ–Ω—å</th><th>–ü–æ—á–∞—Ç–æ–∫</th><th>–ö—ñ–Ω–µ—Ü—å</th></tr></thead><tbody id="schedBody"></tbody></table><button type="submit" class="btn btn-info w-100 text-white fw-bold">–û–Ω–æ–≤–∏—Ç–∏ –†–æ–∑–∫–ª–∞–¥</button></form></div></div></div></div>

<script>
    async function loadDoctors() {
        const res = await fetch('/doctors/');
        const docs = await res.json();
        const tbody = document.getElementById('doctorsTableBody');
        tbody.innerHTML = '';
        docs.forEach(d => {
            let selectClass = 'form-select-sm ';
            if (d.availability_status === 'Available') selectClass += 'border-success text-success';
            else if (d.availability_status === 'Fired') selectClass += 'border-danger text-danger bg-light';
            else selectClass += 'border-warning text-dark';
            tbody.innerHTML += `<tr><td>${d.id}</td><td>${d.first_name} ${d.last_name}</td><td>${d.specialization}</td><td>${d.price_per_visit} –≥—Ä–Ω</td><td><select class="form-select ${selectClass}" onchange="changeStatus(${d.id}, this.value)"><option value="Available" ${d.availability_status === 'Available' ? 'selected' : ''}>üü¢ –ü—Ä–∞—Ü—é—î</option><option value="Sick Leave" ${d.availability_status === 'Sick Leave' ? 'selected' : ''}>ü§í –õ—ñ–∫–∞—Ä–Ω—è–Ω–∏–π</option><option value="Vacation" ${d.availability_status === 'Vacation' ? 'selected' : ''}>üèñÔ∏è –í—ñ–¥–ø—É—Å—Ç–∫–∞</option><option value="Fired" ${d.availability_status === 'Fired' ? 'selected' : ''}>üî¥ –ó–≤—ñ–ª—å–Ω–µ–Ω–∏–π</option></select></td><td><button class="btn btn-sm btn-outline-warning" onclick='openEdit(${JSON.stringify(d)})'>‚úèÔ∏è</button> <button class="btn btn-sm btn-outline-info" onclick="openSchedule(${d.id})">üìÖ</button></td></tr>`;
        });
    }
    async function changeStatus(id, newStatus) {
        const res = await fetch(`/doctors/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ availability_status: newStatus }) });
        if (res.ok) { showToast(`–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–µ–Ω–æ!`); loadDoctors(); } else showToast('–ü–æ–º–∏–ª–∫–∞', 'danger');
    }
    async function loadDepartments() {
        const select = document.getElementById('newDept');
        if (select.options.length > 1) return;
        const res = await fetch('/departments/');
        const depts = await res.json();
        select.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>';
        depts.forEach(d => { const opt = document.createElement('option'); opt.value = d.id; opt.text = `${d.name} (${d.location})`; select.appendChild(opt); });
    }
    document.getElementById('addDoctorForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = { first_name: document.getElementById('newFirst').value, last_name: document.getElementById('newLast').value, specialization: document.getElementById('newSpec').value, department_id: document.getElementById('newDept').value, price_per_visit: document.getElementById('newPrice').value, schedule_start: document.getElementById('schedStart').value, schedule_end: document.getElementById('schedEnd').value };
        const res = await fetch('/doctors/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if (res.ok) { showToast('‚úÖ –õ—ñ–∫–∞—Ä—è –¥–æ–¥–∞–Ω–æ!'); bootstrap.Modal.getInstance(document.getElementById('addDoctorModal')).hide(); loadDoctors(); } else showToast('‚ùå –ü–æ–º–∏–ª–∫–∞', 'danger');
    }
    window.openEdit = function(d) { document.getElementById('editDocId').value = d.id; document.getElementById('editFirst').value = d.first_name; document.getElementById('editLast').value = d.last_name; document.getElementById('editPrice').value = d.price_per_visit; document.getElementById('editSpec').value = d.specialization; new bootstrap.Modal(document.getElementById('editDoctorModal')).show(); }
    document.getElementById('editDoctorForm').onsubmit = async (e) => { e.preventDefault(); const id = document.getElementById('editDocId').value; const data = { first_name: document.getElementById('editFirst').value, last_name: document.getElementById('editLast').value, specialization: document.getElementById('editSpec').value, price_per_visit: document.getElementById('editPrice').value }; const res = await fetch(`/doctors/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); if (res.ok) { showToast('‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ!'); bootstrap.Modal.getInstance(document.getElementById('editDoctorModal')).hide(); loadDoctors(); } else showToast('‚ùå –ü–æ–º–∏–ª–∫–∞', 'danger'); }
    const daysList = ["–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü'—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞", "–ù–µ–¥—ñ–ª—è"];
    window.openSchedule = async function(docId) {
        document.getElementById('schedDocId').value = docId;
        const res = await fetch(`/doctors/${docId}/schedule`);
        const schedule = await res.json();
        const tbody = document.getElementById('schedBody');
        tbody.innerHTML = '';
        daysList.forEach(day => {
            const existing = schedule.find(s => s.day_of_week === day);
            const startVal = existing ? existing.start_time.slice(0, 5) : "09:00";
            const endVal = existing ? existing.end_time.slice(0, 5) : "17:00";
            tbody.innerHTML += `<tr><td>${day}</td><td><input type="time" class="form-control form-control-sm sched-start" data-day="${day}" value="${startVal}"></td><td><input type="time" class="form-control form-control-sm sched-end" data-day="${day}" value="${endVal}"></td></tr>`;
        });
        new bootstrap.Modal(document.getElementById('scheduleModal')).show();
    }
    document.getElementById('scheduleForm').onsubmit = async (e) => {
        e.preventDefault();
        const docId = document.getElementById('schedDocId').value;
        const schedules = [];
        daysList.forEach(day => {
            const start = document.querySelector(`.sched-start[data-day="${day}"]`).value;
            const end = document.querySelector(`.sched-end[data-day="${day}"]`).value;
            schedules.push({ day_of_week: day, start_time: start, end_time: end });
        });
        const res = await fetch(`/doctors/${docId}/schedule`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ schedules: schedules }) });
        if (res.ok) { showToast('‚úÖ –†–æ–∑–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ!'); bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide(); } else showToast('‚ùå –ü–æ–º–∏–ª–∫–∞', 'danger');
    }
    loadDoctors();
</script>
{% endblock %}